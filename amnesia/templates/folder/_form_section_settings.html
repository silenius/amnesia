<div class="form_section">
    <div class="form_title"><input type="checkbox" name="rss" />RSS feed</div>
    <div class="form_description">If selected, an RSS feed will be available for this folder.</div>
</div>

<!-- BEGIN: DEFAULT VIEW -->

<div class="form_section" tal:condition="content_id | None">
    <div class="form_title">
        <input type="checkbox" id="select_page" />Replace default page
        <input type="hidden" id="index_content_id" name="index_content_id" />
    </div>
    <div class="form_description">Select item which will be displayed as the default page of the folder.</div>
    <div id="replace_content" style="margin:10px"></div>
    <div id="replace_pagination" style="margin-top:10px" class="clear"></div>

    <script type="text/javascript">
        /* <![CDATA[ */
        document.addEventListener('DOMContentLoaded', function() {
            if (Yeti.Element('index_content_id').value) {
                Yeti.Element('select_page').click();
            }

            Yeti.Element('select_page').addEventListener('click', function() {
                if (this.checked) {

                    /***********
                     * BROWSER *
                     ***********/

                    var pagination = new Bbpf.Pagination({}),
                        folder_browser = new Bbpf.FolderController({
                            url : "${url('/%s/browse' % content_id)}",
                            components : {
                                main : new Bbpf.Component({
                                    container : 'replace_content'
                                }),
                                pagination : new Bbpf.PaginationComponent({
                                    container : 'replace_pagination',
                                    pagination : pagination
                                })
                            },
                            parameters : {
                                display : "select_default_view",
                                limit : pagination.get('limit'),
                                filter_content_type : ['page']
                            }
                        });

                    pagination.dispatcher.add('pagination_change', function() {
                        folder_browser.refresh({
                            limit: this.get('limit'),
                            offset: this.get('offset')
                        });
                    });

                    folder_browser.dispatcher.add('after_load_success', function() {
                        var inputs = Yeti.Element('replace_content').getElementsByTagName('input'); 
                        for (var i=0, _len = inputs.length; i<_len; i++) {
                            var input = inputs[i];

                            if (input.getAttribute('data-purpose') == 'select_obj' && 
                                input.value == Yeti.Element('index_content_id').value) {
                                input.checked = 'checked';
                            }

                            (function(elem) {
                                Yeti.Evt.bind(elem, 'click', function() {
                                    Yeti.Element('index_content_id').value = elem.value;
                                })
                            })(input);
                        }
                    });

                    folder_browser.load({});

                } else {
                    Yeti.Element('index_content_id').value = '';
                    Yeti.DOM.removeNodes(Yeti.Element('replace_content'));
                    Yeti.DOM.removeNodes(Yeti.Element('replace_pagination'));
                };
            });
        });
        /* ]]> */
    </script>

</div>

<!-- END: DEFAULT VIEW -->

<div class="form_section left" style="width:50%">

    <!-- BEGIN: POLYMORPHIC LOADING -->

    <div id="polymorphic_loading_selection">
        <div class="form_title">
            <input type="checkbox" id="polymorphic_loading" name="polymorphic_loading" />Polymorphic loading
        </div>
        <div class="form_description">
            If checked, all descending mapped classes will be added to the FROM
            clause, unless a selection is made below.
        </div>
    </div>

    <div>
        <select data-select="polymorphic_children" id="polymorphic_children" name="polymorphic_children" multiple="multiple" size="10">
            <tal:block repeat="m polymorphic_it">
                <option tal:condition="m.polymorphic_identity" value="${m.polymorphic_identity}">${m.class_.__name__}</option>
            </tal:block>
        </select>
    </div>

    <script type="text/javascript">
        /* <![CDATA[ */

        document.addEventListener('DOMContentLoaded', function() {

        /***********************
         * POLYMORPHIC LOADING *
         ***********************/

        var MapperSelection = function(p) {
            this.dispatcher = new Yeti.Tools.Dispatcher(this);
            this.select = Yeti.Element(p.select);
            this.pl_button = Yeti.Element(p.pl_button);

            this.add_select_loading_handler();
            this.add_select_mapper_handler();
        }

        MapperSelection.prototype.get_polymorphic_loading = function() {
            return this.pl_button.checked;
        }

        // Return selected mappers
        MapperSelection.prototype.get_selected_mappers = function() {
            var opts = this.select.options,
                selected = [];

            for (var i=0, _len = opts.length; i<_len; i++) {
                if (opts[i].selected) {
                    selected.push(opts[i].value);
                }
            }

            return selected;
        }

        // Unselect all mappers in the selection list
        MapperSelection.prototype.unselect_mappers = function() {
            var opts = this.select.options;

            for (var i=0, _len = opts.length; i<_len; i++) {
                opts[i].selected = false;
            }
        }

        // Display or hide the mapper selection list
        MapperSelection.prototype.display_mapper_select_box = function(checked) {
            this.polymorphic_loading = checked;
            this.select.disabled = !this.polymorphic_loading;

            if (!this.polymorphic_loading) {
                this.unselect_mappers();
            }
        }

        /* Add click event on the "Polymorphic loading" <input> checkbox */
        MapperSelection.prototype.add_select_loading_handler = function() {
           var _self = this;

            this.pl_button.addEventListener('click', function(e) {
                var button = e.currentTarget;

                _self.display_mapper_select_box(button.checked);

                _self.dispatcher.fire('select-mappers', {
                    pl: button.checked,
                    pc: button.checked ? '*' : []
                });
            }, false);
        }

        /* Add change event on the <select> (mapper list) */
        MapperSelection.prototype.add_select_mapper_handler = function() {
            var _self = this;

            this.select.addEventListener('change', function(e) {
                _self.dispatcher.fire('select-mappers', {
                    pl: _self.pl_button.checked,
                    pc: _self.get_selected_mappers()
                });
            }, false);
        }

        /*****************
         * DEFAULT ORDER *
         *****************/

        var OrderSelection = function(params) {
            var _self = this;
            this.container = Yeti.Element(params.container);
            this.orders = Yeti.Element(params.orders);
            this.dispatcher = new Yeti.Tools.Dispatcher(this);

            this.dispatcher.add('after-refresh-order', function() {
                _self.add_weight_handlers();
            });
        }

        OrderSelection.prototype.get_orders = function() {
            var params = [],
                trs = this.container.getElementsByTagName('tr');

            for (var i=0, _len = trs.length; i<_len; i++) {
                var tr = trs[i],
                    data = JSON.parse(tr.getAttribute('data-json'));

                if (data) {
                    if (Yeti.DOM.firstElementChild(tr.cells[0]).checked) {
                        params.push({
                            key : data.key,
                            order : Yeti.DOM.firstElementChild(tr.cells[2]).value,
                            nulls : Yeti.DOM.firstElementChild(tr.cells[3]).value
                        });
                    }
                }
            }

            return params;
        }

        /* Fetch available order for given polymorphic loading/polymorphic
         * identities */
        OrderSelection.prototype.refresh_order = function(params) {
            var _self = this;

            Yeti.AjaxRequest("${url('/content/polymorphic_orders')}", {
                method: 'GET',
                accept: 'xml',
                data: params,
                onreadystatechange: function(req) {
                    if (req.success()) {
                        var data = req.o.responseXML;
                        Yeti.DOM.removeNodes(_self.orders);
                        Yeti.DOM.appendClone(_self.orders,
                            Yeti.DOM.importNode(
                                Yeti.DOM.firstElementChild(data),
                                true
                            )
                        );
                        _self.dispatcher.fire('after-refresh-order');
                    }
                }
            });
        }

        OrderSelection.prototype.change_weight = function(p) {
            var row = p.src;
            do {
               row = row.parentNode;
            } while (row.tagName.toUpperCase() != 'TR');

            var t = row.offsetParent, src, dst;

            if (p.direction == 'up') {
                src = row;
                dst = t.rows[row.rowIndex - 1];
            } else if (p.direction == 'down') {
                src = t.rows[row.rowIndex + 1];
                dst = row;
            }

            if (src && dst) {
                row.parentNode.insertBefore(src, dst);
            }
        }

        OrderSelection.prototype.add_weight_handlers = function() {
            var a = this.container.querySelectorAll('a[data-move]'),
                _self = this;

            for (var i=0, _len = a.length; i<_len; i++) {
                a[i].addEventListener('click', function(e) {
                    _self.change_weight({
                        src: e.currentTarget,
                        direction: this.getAttribute('data-move')
                    });
                });
            }
        }

        /*****************************************************************/

        var mapper_selection = new MapperSelection({
                select: 'polymorphic_children',
                pl_button: 'polymorphic_loading'
            }),
            order_selection = new OrderSelection({
                container: 'order_selection',
                orders: 'available_orders'
            });

        mapper_selection.display_mapper_select_box(mapper_selection.pl_button.checked);

        mapper_selection.dispatcher.add('select-mappers', function(p) {
            order_selection.refresh_order({
                pl: p.pl,
                pc: p.pc,
                selected: JSON.stringify(order_selection.get_orders())
            });
        });

        order_selection.refresh_order({
            pl: mapper_selection.get_polymorphic_loading(),
            pc: mapper_selection.get_selected_mappers(),
            selected: JSON.stringify(${default_order})
        });

        document.forms.folder_form.addEventListener('submit', function() {
            Yeti.Element('default_order').value = JSON.stringify(order_selection.get_orders());
            this.submit();
        });

        });

        /* ]]> */
    </script>

    <!-- END: POLYMORPHIC LOADING -->

</div>

<div class="form_section left" style="margin-left:50px">

    <!-- BEGIN: DEFAULT SORT / ORDERING -->

    <div class="form_title">Ordering</div>
    <div class="form_description">Default ordering.</div>
    <div id="order_selection">
        <div id="available_orders"></div>
    </div>

    <input type="hidden" id="default_order" name="default_order" />

    <!-- END: DEFAULT SORT / ORDERING -->
</div>
