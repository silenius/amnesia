<metal:block use-macro="load: ../layout.html"
             tal:define="content item">
<html>
    <head>
        <metal:block fill-slot="title_more">: ${item.title}</metal:block>
        <script metal:fill-slot="head-bottom" type="text/javascript">

            /* <![CDATA[ */

            document.addEventListener("DOMContentLoaded", function(e) {
                var folder = new Bbpf.Folder(${h.dump_obj(item, 'json',
                        exclude_columns=['fts', 'position_in_container'], include_relations=False)}),
                    counter = new Bbpf.Counter({
                        target : 'select_counter'
                    }),
                    spinner = new Bbpf.Spinner({
                        target : 'spinner',
                        images : {
                            load : "${url('/images/spinner.gif')}",
                            error : "${url('/images/exclamation.png')}"
                        }
                    }),
                    pagination = new Bbpf.Pagination({
                        values : {
                            limit: 50
                        }
                    }),
                    folder_browser = new Bbpf.FolderController({
                        url : '${item.url_for("browse")}',
                        folder : folder,
                        components : {
                            main : new Bbpf.FolderAdminComponent({
                                container : 'content'
                            }),
                            pagination : new Bbpf.PaginationComponent({
                                container : 'pagination',
                                pagination : pagination
                            })
                        },
                        parameters : {
                            display : 'tabular',
                            limit: pagination.get('limit'),
                            undeferred : ['position_in_container', 'count_children'],
                        }
                    })
                ; // var

                folder_browser.add_delete_selection_handler('delete_obj_selection');
                folder_browser.add_cut_selection_handler('cut_obj_selection');

                folder_browser.components.main.dispatcher.add('select_object', function(params) {
                    params.src.checked ? folder_browser.add_selection(params.obj.id) :
                                         folder_browser.remove_selection(params.obj.id);

                    Yeti.Element('select_container_action').style.display = folder_browser.selection.length > 0 ? 
                    '' : 'none';
                    counter.set_value(folder_browser.selection.length);
                });

                folder_browser.components.main.dispatcher.add('move_object', function(params) {
                    folder_browser.move(params);
                });

                pagination.dispatcher.add('pagination_change', function() {
                    folder_browser.refresh({
                        limit: this.get('limit'),
                        offset: this.get('offset')
                    });
                });

                folder_browser.dispatcher.add('before_load', function() {
                    spinner.set('load');
                });

                folder_browser.dispatcher.add('after_selection_clicked', function(params) {
                    params.src.checked ? counter.inc() : counter.dec();
                });

                folder_browser.dispatcher.add('after_load_success', function() {
                    spinner.hide();
                    this.components.main.toggle_select_objs(this.selection);
                });

                folder_browser.dispatcher.add('after_load_failure', function() {
                    spinner.set('error');
                });

                folder_browser.dispatcher.add('after_delete_success', function() {
                    counter.reset();
                });

                folder.dispatcher.add('after_paste_success', function() {
                    site.clipboard.clear();
                    folder_browser.refresh({});
                });

                folder_browser.dispatcher.add('after_copy_success', function(params) {
                    site.clipboard.update(params.data);
                });

                folder_browser.load();

                if (site.clipboard && site.clipboard.count() > 0) {
                    site.clipboard.dispatcher.add('object_paste', function(params) {
                        folder_browser.folder.paste(params.objs);
                    });
                }

                folder_browser.add_sort_handler('browse');

            });

            /* ]]> */

        </script>
    </head>

    <body>
    <div metal:fill-slot="content" id="main">

        <!-- BEGIN: TITLE -->

        <div class="title folder_title">
            <div class="right">

                <div id="select_container_action" class="left" style="display:none">
                    <span style="vertical-align:top;">
                        <span id="select_counter" style="font-weight:bold">0</span> item(s) selected :
                    </span>
                    <a title="Delete selected objects" href="#" id="delete_obj_selection"><img src="${url('/images/application_form_delete.png')}" class="link" /></a>
                    <a title="Cut selected objects" href="#" id="cut_obj_selection"><img src="${url('/images/cut.png')}" class="link" /></a>
                </div>

                <div style="margin-left:15px;" class="left">
                    <metal:block use-macro="load: _action_buttons.html" tal:define="content item; mode 'view'" />
                </div>
            </div>

            <h1>
                ${item.title} 
                <img src="${url('/images/spinner.gif')}" style="vertical-align:middle;" id="spinner" />
            </h1>

            <div class="left posted" tal:switch="item.count_children &gt; 0">
                last modified ${h.format_date(item.last_update)} - 
                <span tal:case="True">${item.count_children} item(s)</span>
                <span tal:case="False">no visible items</span>
            </div>

        </div>

        <!-- END: TITLE -->

        <div tal:condition="item.container_id" style="margin-bottom:10px;clear:both">
            <img src="${url('/images/folder_up.png')}" class="title" />
            <a href="${url('/%s/admin' % item.container_id)}">up one level</a>
        </div>

        <!-- BEGIN: BROWSER -->

        <table class="browse" style="clear:both" id="browse">
            <thead>
                <tr>
                    <th style="text-align:left;padding:0"></th>
                    <th style="text-align:left"><a class="sort" data-sort="title" href="#">Title</a></th>
                    <th><a class="sort" data-sort="type" href="#">Type</a></th>
                    <th><a class="sort" data-sort="update" href="#">Last modified</a></th>
                    <th><a class="sort" data-sort="owner" href="#">Owner</a></th>
                    <th class="weight"><a class="sort" data-sort="weight" href="#">Weight</a></th>
                    <th class="state"><a class="sort" data-sort="state" href="#">State</a></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="content"></tbody>
        </table>

        <!-- END: BROWSER -->

        <div id="pagination" style="margin-top:10px" class="clear">
            <!-- PAGINATION -->
        </div>

    </div>
    </body>
</html>
</metal:block>
